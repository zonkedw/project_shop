const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const rateLimit = require('express-rate-limit');
require('dotenv').config();

// Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð²
const authRoutes = require('./routes/auth');
const productsRoutes = require('./routes/products');
const newsRoutes = require('./routes/news');
const ordersRoutes = require('./routes/orders');

// Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
const pool = require('./config/database');

const app = express();
const PORT = process.env.PORT || 4000;

// Middleware Ð´Ð»Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
app.use(helmet());

// CORS Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ - Ñ€Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ Ð²ÑÐµ Ð¿Ð¾Ñ€Ñ‚Ñ‹ localhost
app.use(cors({
  origin: [
    'http://localhost:3000',
    'http://localhost:3001', 
    'http://localhost:3002',
    process.env.FRONTEND_URL
  ].filter(Boolean),
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS', 'HEAD'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));

// Ð¯Ð²Ð½Ð¾ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÐ¼ Ð½Ð° preflight-Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹
app.options('*', cors({
  origin: [
    'http://localhost:3000',
    'http://localhost:3001', 
    'http://localhost:3002',
    process.env.FRONTEND_URL
  ].filter(Boolean),
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS', 'HEAD'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));

// Rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 Ð¼Ð¸Ð½ÑƒÑ‚
  max: 100, // Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 100 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ñ Ð¾Ð´Ð½Ð¾Ð³Ð¾ IP Ð·Ð° 15 Ð¼Ð¸Ð½ÑƒÑ‚
  message: {
    error: 'Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ IP, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ'
  }
});
app.use('/api/', limiter);

// Middleware Ð´Ð»Ñ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° JSON
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// Middleware Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸ Ñ‚ÐµÐ»Ð° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
app.use('/api/news', (req, res, next) => {
  console.log('=== NEWS API REQUEST DEBUG ===');
  console.log('Method:', req.method);
  console.log('URL:', req.url);
  console.log('Headers:', req.headers);
  console.log('Raw Body:', req.body);
  console.log('Content-Type:', req.get('Content-Type'));
  console.log('Content-Length:', req.get('Content-Length'));
  console.log('================================');
  next();
});

// Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð² development Ñ€ÐµÐ¶Ð¸Ð¼Ðµ
if (process.env.NODE_ENV === 'development') {
  app.use((req, res, next) => {
    console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
    if (req.method === 'POST' && req.path.includes('/news')) {
      console.log('Request body:', req.body);
      console.log('Content-Type:', req.headers['content-type']);
      console.log('Authorization:', req.headers['authorization'] ? 'Ð•ÑÑ‚ÑŒ' : 'ÐÐµÑ‚');
    }
    next();
  });
}

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ ÑÐµÑ€Ð²ÐµÑ€Ð°
app.get('/health', async (req, res) => {
  try {
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
    await pool.query('SELECT 1');
    res.json({
      status: 'OK',
      timestamp: new Date().toISOString(),
      database: 'Connected'
    });
  } catch (error) {
    res.status(500).json({
      status: 'ERROR',
      timestamp: new Date().toISOString(),
      database: 'Disconnected',
      error: error.message
    });
  }
});

// Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ endpoint Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ JSON Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð°
app.post('/test-json', (req, res) => {
  console.log('TEST JSON ENDPOINT');
  console.log('Headers:', req.headers);
  console.log('Body:', req.body);
  console.log('Body type:', typeof req.body);
  
  res.json({
    message: 'JSON Ñ‚ÐµÑÑ‚ ÑƒÑÐ¿ÐµÑˆÐµÐ½',
    receivedBody: req.body,
    bodyType: typeof req.body,
    timestamp: new Date().toISOString()
  });
});

// API Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹
app.use('/api/auth', authRoutes);
app.use('/api/products', productsRoutes);
app.use('/api/news', newsRoutes);
app.use('/api/orders', ordersRoutes);

// Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚
app.get('/', (req, res) => {
  res.json({
    message: 'FoodShop API Server',
    version: '1.0.0',
    endpoints: {
      auth: '/api/auth',
      products: '/api/products',
      news: '/api/news',
      orders: '/api/orders',
      health: '/health'
    }
  });
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð½ÐµÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð²
app.use('*', (req, res) => {
  res.status(404).json({
    error: 'ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½',
    path: req.originalUrl,
    method: req.method
  });
});

// Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
app.use((error, req, res, next) => {
  console.error('Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°:', error);
  
  res.status(error.status || 500).json({
    error: process.env.NODE_ENV === 'production' 
      ? 'Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' 
      : error.message,
    ...(process.env.NODE_ENV === 'development' && { stack: error.stack })
  });
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
app.listen(PORT, () => {
  console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
  console.log(`ðŸŒ API Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: http://localhost:${PORT}`);
  console.log(`ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ: http://localhost:${PORT}/health`);
  console.log(`ðŸ”§ Ð ÐµÐ¶Ð¸Ð¼: ${process.env.NODE_ENV || 'development'}`);
});

// Graceful shutdown
process.on('SIGTERM', () => {
  console.log('SIGTERM Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½, Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ ÑÐµÑ€Ð²ÐµÑ€Ð°...');
  pool.end(() => {
    console.log('ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¾');
    process.exit(0);
  });
});

process.on('SIGINT', () => {
  console.log('SIGINT Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½, Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ ÑÐµÑ€Ð²ÐµÑ€Ð°...');
  pool.end(() => {
    console.log('ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¾');
    process.exit(0);
  });
});
